<div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 w-72 my-4">
    {% csrf_token %}
    <div class="flex justify-between items-center mb-3">
        <div class="flex flex-col">
            <h3 class="text-lg font-bold text-gray-800">Meteo</h3>
            <div id="weather-date-temp" class="text-xs text-gray-600">
                <span id="weather-day">Caricamento...</span>
                <span id="weather-temp-range" class="ml-2"></span>
            </div>
        </div>
        <button type="button" onclick="refreshWeatherData()" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition duration-200 ease-in-out" title="Aggiorna">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </button>
    </div>
    
    <div id="weather-container" class="space-y-2">
        <!-- Weather forecasts will be loaded here -->
        <div id="weather-loading" class="text-center py-4">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <p class="mt-1 text-xs text-gray-600">Caricamento...</p>
        </div>
        
        <div id="weather-error" class="hidden text-center py-4">
            <div class="text-gray-500 mb-1">
                <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.002 4.002 0 003 15z"></path>
                </svg>
            </div>
            <p class="text-gray-600 text-xs">Impossibile ricevere dati meteo</p>
        </div>
        
        <div id="weather-forecasts" class="space-y-1">
            <!-- Dynamic weather forecast items will be inserted here -->
        </div>
    </div>
    
    <!-- City info -->
    <div class="mt-3 pt-2 border-t border-gray-200 text-xs text-gray-500 text-center">
        <span id="weather-city">Reggio Emilia</span> • <span id="weather-updated">mai</span>
    </div>
</div>

<script>
let weatherData = null;
let lastWeatherUpdate = null;

// Inizializza il meteo al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    loadWeatherData();
});

// Carica i dati meteo
function loadWeatherData() {
    document.getElementById('weather-loading').classList.remove('hidden');
    document.getElementById('weather-error').classList.add('hidden');
    document.getElementById('weather-forecasts').innerHTML = '';
    
    // Usa API reale per Open-Meteo
    fetch('/weather/data/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('weather-loading').classList.add('hidden');
        
        if (data.success) {
            weatherData = data;
            displayWeatherData(data);
            lastWeatherUpdate = new Date();
            updateLastUpdateTime();
        } else {
            showWeatherError();
        }
    })
    .catch(error => {
        console.error('Errore nel caricamento meteo:', error);
        document.getElementById('weather-loading').classList.add('hidden');
        showWeatherError();
    });
}

// Mostra i dati meteo
function displayWeatherData(data) {
    // Aggiorna il titolo e le temperature min/max
    document.getElementById('weather-day').textContent = data.day_name;
    
    const tempRange = data.min_temp && data.max_temp 
        ? `${data.max_temp}°/${data.min_temp}°` 
        : '';
    document.getElementById('weather-temp-range').textContent = tempRange;
    document.getElementById('weather-city').textContent = data.city;
    
    // Crea gli elementi per ogni previsione oraria
    const forecastsContainer = document.getElementById('weather-forecasts');
    forecastsContainer.innerHTML = '';
    
    data.forecasts.forEach(forecast => {
        const forecastElement = createForecastElement(forecast);
        forecastsContainer.appendChild(forecastElement);
    });
}

// Crea un elemento previsione oraria
function createForecastElement(forecast) {
    const div = document.createElement('div');
    div.className = 'flex items-center justify-between py-2 px-1 hover:bg-gray-50 rounded transition duration-200';
    
    const iconUrl = `https://openweathermap.org/img/wn/${forecast.icon}@2x.png`;
    
    div.innerHTML = `
        <div class="flex items-center space-x-2">
            <div class="flex-shrink-0">
                <div class="text-xs font-medium text-gray-600">${forecast.hour}</div>
            </div>
            <div class="flex items-center space-x-1">
                <img src="${iconUrl}" alt="${forecast.description}" class="w-6 h-6" onerror="this.style.display='none';">
                <div class="flex flex-col">
                    <div class="text-sm font-semibold text-gray-800">${forecast.temperature}°</div>
                </div>
            </div>
        </div>
        <div class="text-right">
            <div class="text-xs text-gray-600">${forecast.description}</div>
            <div class="text-xs text-gray-400">
                ${forecast.humidity}% • ${forecast.wind_speed}m/s
            </div>
        </div>
    `;
    
    return div;
}

// Mostra errore meteo
function showWeatherError() {
    document.getElementById('weather-error').classList.remove('hidden');
}

// Refresh dei dati meteo
function refreshWeatherData() {
    loadWeatherData();
}

// Aggiorna il tempo dell'ultimo aggiornamento
function updateLastUpdateTime() {
    if (lastWeatherUpdate) {
        const now = new Date();
        const diffMinutes = Math.floor((now - lastWeatherUpdate) / 60000);
        
        let timeText;
        if (diffMinutes < 1) {
            timeText = 'ora';
        } else if (diffMinutes === 1) {
            timeText = '1 min fa';
        } else if (diffMinutes < 60) {
            timeText = `${diffMinutes} min fa`;
        } else {
            const diffHours = Math.floor(diffMinutes / 60);
            timeText = diffHours === 1 ? '1h fa' : `${diffHours}h fa`;
        }
        
        document.getElementById('weather-updated').textContent = timeText;
    }
}

// Aggiorna il tempo ogni minuto
setInterval(updateLastUpdateTime, 60000);

// Auto-refresh ogni 30 minuti
setInterval(loadWeatherData, 30 * 60 * 1000);
</script>

<!-- CSS aggiuntivo per animazioni meteo -->
<style>
.weather-icon-bounce {
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

.weather-forecast-item:hover {
    transform: translateX(2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Loader animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.animate-spin {
    animation: spin 1s linear infinite;
}
</style>